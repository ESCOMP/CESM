on:
  workflow_call:
    inputs:
      compiler:
        type: string
        required: true

jobs:
  test:
    if: always()
    env:
      CC: mpicc
      FC: mpifort
      CXX: mpicxx
      CIME_MODEL: cesm
      CIME_DRIVER: nuopc
    # needs: setup
    runs-on: hpc-runner
    steps:
      - name: Run ${{ inputs.compiler }} tests
        continue-on-error: true
        run: |
          pwd
          cd cime/scripts
          module load cmake
          qcmd -q main -v PROJECT=P93300606 -A P93300606 -l walltime=02:00:00 -- ./create_test --xml-machine derecho\
              --xml-category github2 --no-run --compiler ${{ inputs.compiler }} --test-id ${GITHUB_RUN_ID}${{ inputs.compiler }}
      - name: check status
        run: |
          cd $SCRATCH
          ./cs.status.${GITHUB_RUN_ID}${{ inputs.compiler }} --expected-fails-file $GITHUB_WORKSPACE/cime_config/testfiles/ExpectedTestFails.xml | grep FAIL | grep -v FAILURE
          retval=$?
          if [ $retval -eq 0 ]; then
            exit 1
          fi
          exit 0